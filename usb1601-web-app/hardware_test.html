<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USB-1601 ç¡¬ä»¶æ£€æµ‹ä¸æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
        }
        .content {
            padding: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f7f8fa;
            border-radius: 10px;
            border: 1px solid #e4e7ed;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #303133;
            display: flex;
            align-items: center;
        }
        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #409EFF;
            margin-right: 10px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .status-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dcdfe6;
        }
        .status-label {
            font-size: 12px;
            color: #909399;
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 16px;
            font-weight: bold;
            color: #303133;
        }
        .status-value.success { color: #67c23a; }
        .status-value.error { color: #f56c6c; }
        .status-value.warning { color: #e6a23c; }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #409EFF;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        button:hover {
            background: #66b1ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(64, 158, 255, 0.4);
        }
        button:disabled {
            background: #c0c4cc;
            cursor: not-allowed;
            transform: none;
        }
        button.success { background: #67c23a; }
        button.success:hover { background: #85ce61; }
        button.warning { background: #e6a23c; }
        button.warning:hover { background: #ebb563; }
        button.danger { background: #f56c6c; }
        button.danger:hover { background: #f78989; }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px 10px;
            border-left: 3px solid #409EFF;
        }
        .log-entry.success { border-left-color: #67c23a; color: #67c23a; }
        .log-entry.error { border-left-color: #f56c6c; color: #f56c6c; }
        .log-entry.warning { border-left-color: #e6a23c; color: #e6a23c; }
        .log-entry.info { border-left-color: #909399; color: #909399; }
        .mode-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dcdfe6;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #409EFF;
        }
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #409EFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”Œ USB-1601 ç¡¬ä»¶æ£€æµ‹ä¸æµ‹è¯•</h1>
            <p>å®æ—¶ç¡¬ä»¶çŠ¶æ€ç›‘æ§ä¸æ•°æ®é‡‡é›†æµ‹è¯•</p>
        </div>

        <div class="content">
            <!-- çŠ¶æ€é¢æ¿ -->
            <div class="section">
                <div class="section-title">ç³»ç»ŸçŠ¶æ€</div>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">è¿æ¥çŠ¶æ€</div>
                        <div class="status-value" id="connectionStatus">æœªè¿æ¥</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">è¿è¡Œæ¨¡å¼</div>
                        <div class="status-value" id="modeStatus">æœªçŸ¥</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">ç¡¬ä»¶çŠ¶æ€</div>
                        <div class="status-value" id="hardwareStatus">æœªæ£€æµ‹</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">é‡‡é›†çŠ¶æ€</div>
                        <div class="status-value" id="acquisitionStatus">å·²åœæ­¢</div>
                    </div>
                </div>
            </div>

            <!-- ç¡¬ä»¶æ£€æµ‹ -->
            <div class="section">
                <div class="section-title">ç¡¬ä»¶æ£€æµ‹</div>
                <div class="button-group">
                    <button onclick="detectHardware()">
                        ğŸ” æ£€æµ‹ç¡¬ä»¶
                    </button>
                    <button onclick="initializeSystem(true)" class="success">
                        ğŸ”§ åˆå§‹åŒ–ç¡¬ä»¶æ¨¡å¼
                    </button>
                    <button onclick="initializeSystem(false)" class="warning">
                        ğŸ’» åˆå§‹åŒ–æ¨¡æ‹Ÿæ¨¡å¼
                    </button>
                </div>
                <div class="mode-switch">
                    <span>æ¨¡æ‹Ÿæ¨¡å¼</span>
                    <label class="switch">
                        <input type="checkbox" id="modeSwitch" onchange="switchMode()">
                        <span class="slider"></span>
                    </label>
                    <span>ç¡¬ä»¶æ¨¡å¼</span>
                </div>
            </div>

            <!-- æ•°æ®é‡‡é›†æ§åˆ¶ -->
            <div class="section">
                <div class="section-title">æ•°æ®é‡‡é›†æ§åˆ¶</div>
                <div class="button-group">
                    <button onclick="startAcquisition()" class="success">
                        â–¶ï¸ å¼€å§‹é‡‡é›†
                    </button>
                    <button onclick="stopAcquisition()" class="danger">
                        â¹ï¸ åœæ­¢é‡‡é›†
                    </button>
                    <button onclick="getStatus()">
                        ğŸ“Š è·å–çŠ¶æ€
                    </button>
                    <button onclick="clearLog()">
                        ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>

            <!-- æ—¥å¿—è¾“å‡º -->
            <div class="section">
                <div class="section-title">ç³»ç»Ÿæ—¥å¿—</div>
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api/hybriddata';
        let isHardwareMode = false;
        
        function addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function updateStatus(field, value, className = '') {
            const element = document.getElementById(field);
            if (element) {
                element.textContent = value;
                element.className = `status-value ${className}`;
            }
        }

        async function detectHardware() {
            try {
                addLog('æ­£åœ¨æ£€æµ‹USB-1601ç¡¬ä»¶...', 'info');
                const response = await fetch(`${API_BASE}/detect-hardware`);
                const data = await response.json();
                
                if (data.hardwareAvailable) {
                    addLog(`âœ… æ£€æµ‹åˆ°ç¡¬ä»¶: è®¾å¤‡ç´¢å¼•=${data.deviceIndex}`, 'success');
                    addLog(`é©±åŠ¨è·¯å¾„: ${data.driverPath}`, 'info');
                    updateStatus('hardwareStatus', 'å·²æ£€æµ‹åˆ°', 'success');
                } else {
                    addLog(`âš ï¸ ${data.message}`, 'warning');
                    if (data.recommendation) {
                        addLog(`å»ºè®®: ${data.recommendation}`, 'info');
                    }
                    updateStatus('hardwareStatus', 'æœªæ£€æµ‹åˆ°', 'warning');
                }
            } catch (error) {
                addLog(`âŒ æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
                updateStatus('hardwareStatus', 'æ£€æµ‹å¤±è´¥', 'error');
            }
        }

        async function initializeSystem(preferHardware) {
            try {
                addLog(`æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ (${preferHardware ? 'ç¡¬ä»¶ä¼˜å…ˆ' : 'æ¨¡æ‹Ÿæ¨¡å¼'})...`, 'info');
                
                const response = await fetch(`${API_BASE}/initialize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ preferHardware })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog(`âœ… ${data.message}`, 'success');
                    updateStatus('connectionStatus', 'å·²è¿æ¥', 'success');
                    updateStatus('modeStatus', data.mode === 'hardware' ? 'ç¡¬ä»¶æ¨¡å¼' : 'æ¨¡æ‹Ÿæ¨¡å¼', 
                        data.mode === 'hardware' ? 'success' : 'warning');
                    
                    isHardwareMode = data.mode === 'hardware';
                    document.getElementById('modeSwitch').checked = isHardwareMode;
                    
                    if (data.hardwareError) {
                        addLog(`ç¡¬ä»¶é”™è¯¯: ${data.hardwareError}`, 'warning');
                    }
                } else {
                    addLog(`âŒ åˆå§‹åŒ–å¤±è´¥: ${data.message}`, 'error');
                    updateStatus('connectionStatus', 'æœªè¿æ¥', 'error');
                }
            } catch (error) {
                addLog(`âŒ é”™è¯¯: ${error.message}`, 'error');
                updateStatus('connectionStatus', 'è¿æ¥å¤±è´¥', 'error');
            }
        }

        async function startAcquisition() {
            try {
                addLog('å¯åŠ¨æ•°æ®é‡‡é›†...', 'info');
                
                const config = {
                    channelCount: 1,
                    sampleRate: 1000,
                    minVoltage: -10,
                    maxVoltage: 10,
                    selfTestMode: !isHardwareMode, // æ¨¡æ‹Ÿæ¨¡å¼ä¸‹è‡ªåŠ¨å¼€å¯è‡ªæµ‹
                    signalType: 'Sine',
                    signalFrequency: 100,
                    signalAmplitude: 5
                };
                
                const response = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog(`âœ… ${data.message}`, 'success');
                    updateStatus('acquisitionStatus', 'é‡‡é›†ä¸­', 'success');
                    addLog(`æ¨¡å¼: ${data.mode}, é‡‡æ ·ç‡: ${config.sampleRate}Hz, é€šé“æ•°: ${config.channelCount}`, 'info');
                } else {
                    addLog(`âŒ å¯åŠ¨å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function stopAcquisition() {
            try {
                addLog('åœæ­¢æ•°æ®é‡‡é›†...', 'info');
                
                const response = await fetch(`${API_BASE}/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog(`âœ… ${data.message}`, 'success');
                    updateStatus('acquisitionStatus', 'å·²åœæ­¢', 'warning');
                } else {
                    addLog(`âŒ åœæ­¢å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function getStatus() {
            try {
                addLog('è·å–ç³»ç»ŸçŠ¶æ€...', 'info');
                
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                
                addLog(`çŠ¶æ€: åˆå§‹åŒ–=${data.isInitialized}, é‡‡é›†ä¸­=${data.isAcquiring}, æ¨¡å¼=${data.mode}`, 'info');
                
                updateStatus('connectionStatus', data.isInitialized ? 'å·²è¿æ¥' : 'æœªè¿æ¥', 
                    data.isInitialized ? 'success' : 'error');
                updateStatus('modeStatus', data.mode === 'hardware' ? 'ç¡¬ä»¶æ¨¡å¼' : 'æ¨¡æ‹Ÿæ¨¡å¼',
                    data.mode === 'hardware' ? 'success' : 'warning');
                updateStatus('hardwareStatus', data.hardwareAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨',
                    data.hardwareAvailable ? 'success' : 'warning');
                updateStatus('acquisitionStatus', data.isAcquiring ? 'é‡‡é›†ä¸­' : 'å·²åœæ­¢',
                    data.isAcquiring ? 'success' : 'warning');
                
                if (data.lastError) {
                    addLog(`æœ€åé”™è¯¯: ${data.lastError}`, 'warning');
                }
            } catch (error) {
                addLog(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function switchMode() {
            const useHardware = document.getElementById('modeSwitch').checked;
            
            try {
                addLog(`åˆ‡æ¢åˆ°${useHardware ? 'ç¡¬ä»¶' : 'æ¨¡æ‹Ÿ'}æ¨¡å¼...`, 'info');
                
                const response = await fetch(`${API_BASE}/switch-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ useHardware })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog(`âœ… ${data.message}`, 'success');
                    updateStatus('modeStatus', data.mode === 'hardware' ? 'ç¡¬ä»¶æ¨¡å¼' : 'æ¨¡æ‹Ÿæ¨¡å¼',
                        data.mode === 'hardware' ? 'success' : 'warning');
                    isHardwareMode = data.mode === 'hardware';
                } else {
                    addLog(`âŒ åˆ‡æ¢å¤±è´¥: ${data.message}`, 'error');
                    // æ¢å¤å¼€å…³çŠ¶æ€
                    document.getElementById('modeSwitch').checked = !useHardware;
                }
            } catch (error) {
                addLog(`âŒ é”™è¯¯: ${error.message}`, 'error');
                document.getElementById('modeSwitch').checked = !useHardware;
            }
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶
        window.onload = () => {
            addLog('ğŸš€ USB-1601 ç¡¬ä»¶æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
            addLog('ç‚¹å‡»"æ£€æµ‹ç¡¬ä»¶"å¼€å§‹æµ‹è¯•', 'info');
            getStatus();
        };
    </script>
</body>
</html>