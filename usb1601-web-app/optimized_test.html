<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USB-1601 ä¼˜åŒ–æµ‹è¯• - æ— å±é—ªç‰ˆæœ¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #303133;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .control-group {
            padding: 20px;
            background: #f7f8fa;
            border-radius: 8px;
            border: 1px solid #e4e7ed;
        }
        .control-group h3 {
            color: #606266;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .control-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .control-item label {
            color: #909399;
            font-size: 14px;
        }
        .control-item input,
        .control-item select {
            padding: 5px 10px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            width: 120px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #409EFF;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(64, 158, 255, 0.4);
        }
        button:disabled {
            background: #c0c4cc;
            cursor: not-allowed;
            transform: none;
        }
        button.success { background: #67c23a; }
        button.danger { background: #f56c6c; }
        button.warning { background: #e6a23c; }
        
        .canvas-container {
            position: relative;
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        #waveformCanvas {
            background: #0a0a0a;
            border-radius: 4px;
            width: 100%;
            height: 400px;
            display: block;
        }
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-item {
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #409EFF;
            text-align: center;
        }
        .stat-label {
            font-size: 12px;
            color: #909399;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #303133;
        }
        .stat-value.success { color: #67c23a; }
        .stat-value.warning { color: #e6a23c; }
        .stat-value.error { color: #f56c6c; }
        
        .performance-info {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #67c23a;
            font-family: monospace;
            font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        /* ä½¿ç”¨CSSç¡¬ä»¶åŠ é€Ÿ */
        #waveformCanvas {
            transform: translateZ(0);
            will-change: transform;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            ğŸ“Š USB-1601 ä¼˜åŒ–æµ‹è¯•
            <span style="font-size: 14px; color: #909399;">ï¼ˆæ— å±é—ªç‰ˆæœ¬ï¼‰</span>
        </h1>

        <div class="control-panel">
            <div class="control-group">
                <h3>ğŸ“¡ è¿æ¥æ§åˆ¶</h3>
                <button onclick="initialize()" class="success">åˆå§‹åŒ–ç³»ç»Ÿ</button>
                <button onclick="detectHardware()">æ£€æµ‹ç¡¬ä»¶</button>
            </div>

            <div class="control-group">
                <h3>âš™ï¸ é‡‡é›†å‚æ•°</h3>
                <div class="control-item">
                    <label>é‡‡æ ·ç‡:</label>
                    <select id="sampleRate">
                        <option value="1000">1 kHz</option>
                        <option value="5000">5 kHz</option>
                        <option value="10000">10 kHz</option>
                        <option value="50000">50 kHz</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>é€šé“æ•°:</label>
                    <select id="channelCount">
                        <option value="1">1é€šé“</option>
                        <option value="2">2é€šé“</option>
                        <option value="4">4é€šé“</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>æ›´æ–°é—´éš”(ms):</label>
                    <input type="number" id="updateInterval" value="50" min="10" max="1000">
                </div>
            </div>

            <div class="control-group">
                <h3>ğŸ“ˆ ä¿¡å·å‚æ•°</h3>
                <div class="control-item">
                    <label>ä¿¡å·ç±»å‹:</label>
                    <select id="signalType">
                        <option value="Sine">æ­£å¼¦æ³¢</option>
                        <option value="Square">æ–¹æ³¢</option>
                        <option value="Triangle">ä¸‰è§’æ³¢</option>
                        <option value="Sawtooth">é”¯é½¿æ³¢</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>é¢‘ç‡(Hz):</label>
                    <input type="number" id="frequency" value="100" min="1" max="10000">
                </div>
                <div class="control-item">
                    <label>å¹…åº¦(V):</label>
                    <input type="number" id="amplitude" value="5" min="0.1" max="10" step="0.1">
                </div>
            </div>

            <div class="control-group">
                <h3>ğŸ® é‡‡é›†æ§åˆ¶</h3>
                <button onclick="startAcquisition()" class="success">â–¶ï¸ å¼€å§‹é‡‡é›†</button>
                <button onclick="stopAcquisition()" class="danger">â¹ï¸ åœæ­¢é‡‡é›†</button>
                <button onclick="clearCanvas()" class="warning">ğŸ—‘ï¸ æ¸…é™¤æ³¢å½¢</button>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="waveformCanvas"></canvas>
            <div class="performance-info" id="perfInfo">
                FPS: <span id="fps">0</span> | 
                æ•°æ®ç‚¹: <span id="dataPoints">0</span> | 
                å»¶è¿Ÿ: <span id="latency">0</span>ms
            </div>
        </div>

        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-label">æœ€å¤§å€¼</div>
                <div class="stat-value" id="maxValue">0.00 V</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æœ€å°å€¼</div>
                <div class="stat-value" id="minValue">0.00 V</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">å¹³å‡å€¼</div>
                <div class="stat-value" id="avgValue">0.00 V</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">å³°å³°å€¼</div>
                <div class="stat-value" id="ppValue">0.00 V</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">é‡‡é›†çŠ¶æ€</div>
                <div class="stat-value" id="status">å·²åœæ­¢</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">è¿è¡Œæ¨¡å¼</div>
                <div class="stat-value" id="mode">æœªçŸ¥</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api/hybriddata';
        
        // Canvasç»˜å›¾ç›¸å…³
        const canvas = document.getElementById('waveformCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        let dataBuffer = [];
        let maxBufferSize = 2000;
        let animationId = null;
        let lastFrameTime = Date.now();
        let fps = 0;
        let frameCount = 0;
        let isAcquiring = false;
        
        // è®¾ç½®Canvaså¤§å°
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        }
        
        // ä¼˜åŒ–çš„ç»˜åˆ¶å‡½æ•°
        function drawWaveform() {
            if (!isAcquiring) return;
            
            // è®¡ç®—FPS
            const now = Date.now();
            const deltaTime = now - lastFrameTime;
            frameCount++;
            
            if (deltaTime >= 1000) {
                fps = Math.round((frameCount * 1000) / deltaTime);
                document.getElementById('fps').textContent = fps;
                frameCount = 0;
                lastFrameTime = now;
            }
            
            // æ¸…é™¤ç”»å¸ƒï¼ˆä½¿ç”¨é»‘è‰²èƒŒæ™¯ï¼‰
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (dataBuffer.length < 2) {
                animationId = requestAnimationFrame(drawWaveform);
                return;
            }
            
            // ç»˜åˆ¶ç½‘æ ¼
            drawGrid();
            
            // ç»˜åˆ¶æ³¢å½¢
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            const xStep = canvas.width / maxBufferSize;
            const yMid = canvas.height / 2;
            const yScale = canvas.height / 20; // Â±10VèŒƒå›´
            
            // ä½¿ç”¨é™é‡‡æ ·ç»˜åˆ¶
            const step = Math.max(1, Math.floor(dataBuffer.length / canvas.width));
            
            for (let i = 0; i < dataBuffer.length; i += step) {
                const x = (i / dataBuffer.length) * canvas.width;
                const y = yMid - (dataBuffer[i] * yScale);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
            
            // è¯·æ±‚ä¸‹ä¸€å¸§
            animationId = requestAnimationFrame(drawWaveform);
        }
        
        // ç»˜åˆ¶ç½‘æ ¼
        function drawGrid() {
            ctx.strokeStyle = 'rgba(64, 158, 255, 0.2)';
            ctx.lineWidth = 0.5;
            
            // æ¨ªçº¿
            for (let i = 0; i <= 10; i++) {
                const y = (canvas.height / 10) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // ç«–çº¿
            for (let i = 0; i <= 20; i++) {
                const x = (canvas.width / 20) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (dataBuffer.length === 0) return;
            
            const max = Math.max(...dataBuffer);
            const min = Math.min(...dataBuffer);
            const avg = dataBuffer.reduce((a, b) => a + b, 0) / dataBuffer.length;
            const pp = max - min;
            
            document.getElementById('maxValue').textContent = max.toFixed(2) + ' V';
            document.getElementById('minValue').textContent = min.toFixed(2) + ' V';
            document.getElementById('avgValue').textContent = avg.toFixed(2) + ' V';
            document.getElementById('ppValue').textContent = pp.toFixed(2) + ' V';
            document.getElementById('dataPoints').textContent = dataBuffer.length;
        }
        
        // WebSocketè¿æ¥
        let ws = null;
        
        function connectWebSocket() {
            // ç®€åŒ–çš„WebSocketè¿æ¥ï¼ˆå®é™…åº”ç”¨ä¸­ä½¿ç”¨SignalRï¼‰
            console.log('WebSocketè¿æ¥åŠŸèƒ½éœ€è¦SignalRæ”¯æŒ');
        }
        
        // æ¨¡æ‹Ÿæ•°æ®æ¥æ”¶ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        function simulateDataReception() {
            const updateInterval = parseInt(document.getElementById('updateInterval').value);
            
            setInterval(() => {
                if (!isAcquiring) return;
                
                // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                const newData = [];
                const time = Date.now() / 1000;
                const freq = parseFloat(document.getElementById('frequency').value);
                const amp = parseFloat(document.getElementById('amplitude').value);
                const type = document.getElementById('signalType').value;
                
                for (let i = 0; i < 100; i++) {
                    let value = 0;
                    const t = time + i * 0.001;
                    
                    switch(type) {
                        case 'Sine':
                            value = amp * Math.sin(2 * Math.PI * freq * t);
                            break;
                        case 'Square':
                            value = amp * (Math.sin(2 * Math.PI * freq * t) > 0 ? 1 : -1);
                            break;
                        case 'Triangle':
                            const period = 1 / freq;
                            const phase = (t % period) / period;
                            value = amp * (4 * Math.abs(phase - 0.5) - 1);
                            break;
                        case 'Sawtooth':
                            const sawPeriod = 1 / freq;
                            const sawPhase = (t % sawPeriod) / sawPeriod;
                            value = amp * (2 * sawPhase - 1);
                            break;
                    }
                    
                    // æ·»åŠ å™ªå£°
                    value += (Math.random() - 0.5) * 0.1;
                    newData.push(value);
                }
                
                // æ·»åŠ åˆ°ç¼“å†²åŒº
                dataBuffer.push(...newData);
                
                // é™åˆ¶ç¼“å†²åŒºå¤§å°
                if (dataBuffer.length > maxBufferSize) {
                    dataBuffer = dataBuffer.slice(-maxBufferSize);
                }
                
                // æ›´æ–°å»¶è¿Ÿæ˜¾ç¤º
                document.getElementById('latency').textContent = updateInterval;
            }, updateInterval);
        }
        
        // APIè°ƒç”¨å‡½æ•°
        async function initialize() {
            try {
                const response = await fetch(`${API_BASE}/initialize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ preferHardware: false })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('åˆå§‹åŒ–æˆåŠŸ: ' + data.message);
                    document.getElementById('mode').textContent = data.mode;
                    document.getElementById('mode').className = 'stat-value ' + 
                        (data.mode === 'hardware' ? 'success' : 'warning');
                }
            } catch (error) {
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        async function detectHardware() {
            try {
                const response = await fetch(`${API_BASE}/detect-hardware`);
                const data = await response.json();
                
                alert(data.hardwareAvailable ? 
                    `æ£€æµ‹åˆ°ç¡¬ä»¶: è®¾å¤‡ç´¢å¼•=${data.deviceIndex}` : 
                    `æœªæ£€æµ‹åˆ°ç¡¬ä»¶: ${data.message}`);
            } catch (error) {
                alert('æ£€æµ‹å¤±è´¥: ' + error.message);
            }
        }
        
        async function startAcquisition() {
            if (isAcquiring) return;
            
            try {
                const config = {
                    channelCount: parseInt(document.getElementById('channelCount').value),
                    sampleRate: parseInt(document.getElementById('sampleRate').value),
                    signalType: document.getElementById('signalType').value,
                    signalFrequency: parseFloat(document.getElementById('frequency').value),
                    signalAmplitude: parseFloat(document.getElementById('amplitude').value),
                    minVoltage: -10,
                    maxVoltage: 10
                };
                
                const response = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    isAcquiring = true;
                    document.getElementById('status').textContent = 'é‡‡é›†ä¸­';
                    document.getElementById('status').className = 'stat-value success';
                    
                    // å¯åŠ¨ç»˜åˆ¶å¾ªç¯
                    drawWaveform();
                    
                    // å¯åŠ¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­é€šè¿‡WebSocketæ¥æ”¶ï¼‰
                    simulateDataReception();
                }
            } catch (error) {
                alert('å¯åŠ¨å¤±è´¥: ' + error.message);
            }
        }
        
        async function stopAcquisition() {
            if (!isAcquiring) return;
            
            try {
                const response = await fetch(`${API_BASE}/stop`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    isAcquiring = false;
                    document.getElementById('status').textContent = 'å·²åœæ­¢';
                    document.getElementById('status').className = 'stat-value error';
                    
                    // åœæ­¢åŠ¨ç”»
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                }
            } catch (error) {
                alert('åœæ­¢å¤±è´¥: ' + error.message);
            }
        }
        
        function clearCanvas() {
            dataBuffer = [];
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            updateStats();
        }
        
        // åˆå§‹åŒ–
        window.onload = () => {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        };
    </script>
</body>
</html>